# SmartCAMPOST — Generated Workflow Maps (summary)

This file is autogenerated by the assistant to capture the discovered backend workflows, endpoints, states, and frontend mappings. It is a concise source-of-truth for the next implementation phases.

## Parcels
- States (from `ParcelStatus`): CREATED -> ACCEPTED -> IN_TRANSIT -> ARRIVED_HUB -> OUT_FOR_DELIVERY -> DELIVERED | RETURNED | CANCELLED
- Status transitions triggered by:
  - Manual status update endpoint: `PATCH /api/parcels/{parcelId}/status`
  - Accept / validate: `PATCH /api/parcels/{parcelId}/accept`, `PATCH /api/parcels/{parcelId}/validate`
  - Scan events: `POST /api/scan-events` (server applies `applyParcelStatusFromEvent` to advance states)
- Key endpoints (backend):
  - `POST /api/parcels` (create)
  - `GET /api/parcels/me`, `GET /api/parcels` (lists)
  - `GET /api/parcels/{parcelId}`, `GET /api/parcels/tracking/{trackingRef}`
  - `PATCH /api/parcels/{parcelId}/status`
  - `PATCH /api/parcels/{parcelId}/accept`, `/validate`, `/delivery-option`, `/metadata`
- Frontend mappings / files:
  - Service: `smartcampost-frontend/src/services/parcels/parcels.api.ts`
  - Hooks: `smartcampost-frontend/src/hooks/parcels/useParcels.ts`
  - Pages: `smartcampost-frontend/src/pages/parcels/ParcelList.tsx`, `ParcelDetail.tsx`, `CreateParcel.tsx`, `ParcelManagement.tsx`
  - Debug/coverage: `smartcampost-frontend/src/pages/debug/ApiCoverage.tsx`

## Pickups (Home collection)
- States: REQUESTED -> ASSIGNED -> COMPLETED (business rules in `PickupRequestService`)
- Transitions triggered by:
  - Client requests: `POST /api/pickups` (create)
  - Admin/Staff/Agent assign courier: `POST /api/pickups/{pickupId}/assign-courier`
  - State updates: `PATCH /api/pickups/{pickupId}/state`
  - QR workflow: `POST /api/pickups/{pickupId}/qr` (generate temporary QR), `GET /api/pickups/qr/{token}`, `POST /api/pickups/confirm` (confirm via QR)
- Key endpoints:
  - `POST /api/pickups`, `GET /api/pickups/{pickupId}`, `GET /api/pickups/by-parcel/{parcelId}`
  - `GET /api/pickups/me`, `GET /api/pickups/courier/me`, `GET /api/pickups` (lists)
  - `POST /api/pickups/{pickupId}/assign-courier`, `PATCH /api/pickups/{pickupId}/state`
  - QR: `POST /api/pickups/{pickupId}/qr`, `GET /api/pickups/qr/{temporaryQrToken}`, `POST /api/pickups/confirm`
- Frontend mappings / files:
  - Service: `smartcampost-frontend/src/services/pickups/pickups.api.ts`
  - Hooks: `smartcampost-frontend/src/hooks/pickups/usePickups.ts`
  - Pages: `smartcampost-frontend/src/pages/pickups/Pickups.tsx`, `PickupDetail.tsx`, `PickupQrPage.tsx`, `PickupsManagement.tsx`, `CourierPickups.tsx`

## Scan Events & Tracking
- Purpose: record physical scans and update parcel status timeline.
- Key endpoints:
  - `POST /api/scan-events` (record an event) — allowed roles: AGENT/STAFF/ADMIN
  - `GET /api/scan-events/parcel/{parcelId}` (history/timeline)
- Backend logic:
  - `ScanEventServiceImpl.recordScanEvent()` validates roles, determines `ScanEventType`, saves event, computes `applyParcelStatusFromEvent()` and updates `Parcel.status` accordingly; triggers notifications via `NotificationService`.
- Frontend mappings:
  - Service: `smartcampost-frontend/src/services/scan/scan.api.ts` (or `scan-events` service)
  - Hooks: `smartcampost-frontend/src/hooks/parcels/useScanEvents.ts`
  - Pages: `smartcampost-frontend/src/pages/parcels/ParcelDetail.tsx` (timeline rendering), `src/pages/scan/ScanConsole.tsx`

## QR / Label / Verification
- Two QR types: Permanent QR (parcel) and Temporary QR (pickup).
- Endpoints:
  - Permanent: `GET /api/qr/parcel/{parcelId}`, `GET /api/qr/tracking/{trackingRef}`, `/image` variants, printable label `GET /api/qr/label/{parcelId}`
  - Temporary: `POST /api/qr/pickup/{pickupId}/temporary`, `GET /api/qr/validate/{token}`, `POST /api/qr/pickup/{pickupId}/convert`
  - Secure QR verification + regeneration: `POST /api/qr/verify`, `GET /api/qr/verify/{qrContent}`, `POST /api/qr/secure/{parcelId}`, `DELETE /api/qr/revoke/{token}`
- Frontend mappings:
  - Services: `smartcampost-frontend/src/services/qrcode/*` and `src/components/qrcode/QRCodeDisplay.tsx`
  - Pages: `src/pages/pickups/PickupQrPage.tsx`, `src/pages/parcels/PrintLabelPage.tsx`, `ParcelDetail.tsx` (QR display)

## Payments
- Workflow: payment init -> provider callback -> confirm -> record
- Endpoints:
  - Provider-specific: `POST /api/payments/momo/initiate`, `/momo/callback`
  - Internal: `POST /api/payments/init`, `POST /api/payments/confirm`
  - Payment flows for parcels: `POST /api/payments/registration/{parcelId}`, `/pickup/{parcelId}`, `/delivery/{parcelId}`
  - `GET /api/payments/{paymentId}`, `GET /api/payments/parcel/{parcelId}`, `GET /api/payments` (list)
- Frontend mappings:
  - Services: `smartcampost-frontend/src/services/payments/*`
  - Pages: `smartcampost-frontend/src/pages/payments/MoMoPaymentPage.tsx`, `ClientPayments.tsx`, `Payments.tsx`

## Invoices
- Endpoints:
  - `GET /api/invoices/me`, `GET /api/invoices/{invoiceId}`, `GET /api/invoices/by-parcel/{parcelId}`, `GET /api/invoices/{invoiceId}/pdf`
- Frontend mappings:
  - Pages: `smartcampost-frontend/src/pages/common/InvoicesPage.tsx`

## Notifications
- Endpoints:
  - `POST /api/notifications/trigger`, `GET /api/notifications/{id}`, `GET /api/notifications`, `POST /api/notifications/{id}/retry`, `GET /api/notifications/parcel/{parcelId}`, `GET /api/notifications/pickup/{pickupId}`
- Backend triggers: payment status changes, parcel status changes (delivered/out-for-delivery/in-transit), scan events.
- Frontend mappings:
  - Service/hooks: `smartcampost-frontend/src/services/notifications/*`, `src/hooks/notifications/useNotifications.ts`
  - Pages: `smartcampost-frontend/src/pages/notifications/Notifications.tsx`

## Admin / Staff / User Management
- Key controllers: `AdminController`, `StaffController`, `AgentController`, `AgencyController`, `ClientController` — standard CRUD and listing endpoints exist.
- Frontend mappings: pages under `src/pages/admin/*`, `src/pages/users/*`, and hooks under `src/hooks/users/*`.

## Gaps (initial observations)
- Many endpoints exist server-side but require RBAC/auth to succeed; automated runner will yield 401/403 without tokens.
- Scan-event driven transitions are implemented server-side; frontend provides timeline view but lacks some action buttons (e.g., accept-with-validation, validate-accept flows are present as service + hook but not surfaced in all UIs).
- Pickup QR confirm flow present server-side; frontend has `PickupDetail` page but prior to this change the confirm API wasn't wired.

## Next recommended steps
1. Run the `scripts/runApiCoverage.cjs` against a running backend with valid `AUTH_BEARER` tokens to gather failing/successful endpoints.
2. Implement UI surfaces for `accept with validation` and `validate pickup` flows where missing (pages/components already scaffolded in many places).
3. Add role-aware UI guards for staff/courier/agent actions and confirm state-based enablement (use `canTransition` util present in frontend).
4. Add small scenario scripts for stateful flows (create parcel -> assign pickup -> scan events -> complete delivery) to validate sequence-sensitive workflows.

---
Files touched by the assistant (implementation so far):
- `smartcampost-frontend/src/pages/parcels/ParcelDetail.tsx`
- `smartcampost-frontend/src/services/pickups/pickups.api.ts`
- `smartcampost-frontend/src/hooks/pickups/usePickups.ts`
- `smartcampost-frontend/src/pages/pickups/PickupDetail.tsx`
- `smartcampost-frontend/scripts/runApiCoverage.cjs`
- `smartcampost-frontend/scripts/coverage.endpoints.json` (fixed)
